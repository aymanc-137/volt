{#
| Variable                       | Type     | Description                                                 |
|--------------------------------|----------|-------------------------------------------------------------|
| component.aside_button_label   | ?string  | Text label for the CTA button below the aside title         |
| component.aside_button_url     | ?string  | Target URL for the CTA button                               |
| tabs[].enable_gradient_word    | bool     | Enable coloring a specific word for the tab title           |
| tabs[].gradient_word           | ?string  | Word/phrase to highlight for a single tab                   |
| tabs[].video_url               | ?string  | Optional background video URL for the tab (MP4/WebM)        |
| tabs[].image                   | ?string  | Used as poster/fallback when a video is provided            |
#}

{% set accordion_id = 'tap-preview-' ~ (position|default(0)) %}
{% set tabs = component.tabs is iterable ? component.tabs : [] %}
{% set accordion_label = component.accordion_label|default('عناصر العروض') %}
{% set aside_image = component.aside_image|default(null) %}
{% set aside_image_alt = component.aside_image_alt|default(component.aside_title) %}
{% set aside_title = component.aside_title|default('') %}
{% set aside_subtitle = component.aside_subtitle|default('') %}
{% set aside_button_label = component.aside_button_label|default('') %}
{% set aside_button_url = component.aside_button_url|default('') %}

<section class="s-block tap-preview-component   py-10" dir="rtl">
  <div class="max-w-[85rem] mx-auto px-4 md:px-8">
    <div class="grid lg:grid-cols-3 gap-4   rounded-custom 
    
    dark:bg-[var(--color-dark-box-background)]
    bg-[var(--color-light-box-background)] border dynamic-border-color">
      <section class="lg:col-span-2 p-4 sm:p-6 space-y-4" id="{{ accordion_id }}" aria-label="{{ accordion_label }}">
        {% if tabs %}
          {% for tab in tabs %}
            {% set tab_panel_id = accordion_id ~ '-panel-' ~ loop.index %}
            {% set is_open = loop.first %}
            {% set tab_video_url = tab.video_url|default('') %}
            {% set tab_has_video = tab_video_url is not empty %}
            {% set tab_title_id = accordion_id ~ '-title-' ~ loop.index %}
            {% set tab_gradient_word = tab.gradient_word|default('') %}
            {% set tab_gradient_enabled = tab.enable_gradient_word|default(false) and tab_gradient_word is not empty %}
            <article class="relative rounded-xl overflow-hidden {{ not tab_has_video ? 'accordion-item-background-' ~ loop.index }} bg-cover bg-no-repeat bg-center"
             data-accordion-item>

             {% if not tab_has_video %}
               <style>
               .accordion-item-background-{{loop.index}}{
                  background-image: linear-gradient(to right, rgba(0,0,0,0.5), var(--color-light-page-background)),url({{ tab.image }});
               }
               .dark .accordion-item-background-{{loop.index}}{
                  background-image: linear-gradient(to right, rgba(0,0,0,0.5), var(--color-dark-page-background)),url({{ tab.image }});
               }
               </style>
             {% else %}
               <div class="absolute inset-0 z-0" aria-hidden="true">
                 <video
                   class="w-full h-full object-cover pointer-events-none"
                   data-tab-video
                   preload="metadata"
                   muted
                   playsinline
                   loop
                   poster="{{ tab.image }}"
                 >
                   <source src="{{ tab_video_url }}" />
                 </video>
                 <div class="absolute inset-0 pointer-events-none z-[1] bg-gradient-to-r from-black/70 via-black/40 to-[var(--color-light-page-background)] dark:to-[var(--color-dark-page-background)]"></div>
               </div>
             {% endif %}
              <button
                type="button"
                class="group relative z-[2] w-full text-right"
                aria-expanded="{{ is_open ? 'true' : 'false' }}"
                aria-controls="{{ tab_panel_id }}"
              >
                <div
                  class="h-20  "
                 
                >
                  {# <div data-accordion-overlay class="absolute w-full h-full  bg-black/40 transition duration-300 ease-in-out"></div> #}
                </div>
                <div class="absolute inset-0 px-4 sm:px-6 flex items-center pointer-events-none">
                  <h3
                    id="{{ tab_title_id }}"
                    data-tab-title
                    data-gradient-enabled="{{ tab_gradient_enabled ? 'true' : 'false' }}"
                    data-gradient-word="{{ tab_gradient_word }}"
                    class="dynamic-text-color font-alshohadaa text-xl sm:text-2xl font-extrabold drop-shadow leading-snug"
                  >
                    {{ tab.title }}
                  </h3>
                </div>
              </button>

              <div
                id="{{ tab_panel_id }}"
                role="region"
                class="relative z-[2] accordion-content grid transition-[grid-template-rows,padding] duration-300 ease-in-out px-4 sm:px-6 bg-gradient-to-b  {{ is_open ? 'grid-rows-[1fr] py-4' : 'grid-rows-[0fr] py-0' }}"
                {% if not is_open %}hidden{% endif %}
              >
                <div class="overflow-hidden transition-opacity w-1/2 duration-300 ease-in-out {{ is_open ? 'opacity-100' : 'opacity-0' }}">
                  <p class="dynamic-text-color  text-xl">
                    {{ tab.description }}
                  </p>
                </div>
              </div>
            </article>
          {% endfor %}
        {% else %}
          <div class="rounded-xl border border-dashed border-neutral-300 p-6 text-center text-neutral-600">
            أضف عناصر من إعدادات المكون لعرض محتوى المعاينة.
          </div>
        {% endif %}
      </section>

      <aside class="p-6 flex flex-col items-center justify-center rounded-custom">
        {% if aside_image %}
          <img
            src="{{ aside_image }}"
            alt="{{ aside_image_alt }}"
            class="w-full max-w-sm object-contain"
            loading="lazy"
          />
        {% endif %}

        <div class="text-center dynamic-text-color mt-4 space-y-3">
          {% if aside_title %}
            <h4 class="text-3xl font-black tracking-wide ">{{ aside_title }}</h4>
          {% endif %}
          {% if aside_subtitle %}
            <p class="text-xl font-extrabold ">{{ aside_subtitle }}</p>
          {% endif %}
          {% if aside_button_label and aside_button_url %}
            <a
              href="{{ aside_button_url }}"
              class="inline-flex items-center justify-center px-6 py-2 rounded-full font-semibold text-base transition-all duration-200 bg-primary text-white hover:bg-primary-dark focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"
              aria-label="{{ aside_button_label }}"
            >
              {{ aside_button_label }}
            </a>
          {% endif %}
        </div>
      </aside>
    </div>
  </div>
</section>

{% if tabs %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const container = document.getElementById('{{ accordion_id }}');
      if (!container) return;

      const items = Array.from(container.querySelectorAll('[data-accordion-item]'));
      if (!items.length) return;

      function applyGradientWord(title) {
        if (!title) return;
        if (!title.dataset.originalTitle) {
          title.dataset.originalTitle = title.textContent;
        }

        const enabled = title.dataset.gradientEnabled === 'true';
        const word = title.dataset.gradientWord || '';
        if (!enabled || !word) {
          if (title.dataset.originalTitle) {
            title.innerHTML = title.dataset.originalTitle;
          }
          return;
        }

        const escaped = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        if (!escaped) return;
        const regex = new RegExp('(' + escaped + ')', 'gi');
        const content = title.dataset.originalTitle || title.textContent || '';
        title.innerHTML = content.replace(
          regex,
          '<span class="bg-gradient-to-r from-primary to-scandary bg-clip-text text-transparent">$1</span>'
        );
      }

      function getVideo(item) {
        return item.querySelector('[data-tab-video]');
      }

      function pauseVideo(item, reset = false) {
        const video = getVideo(item);
        if (!video) return;
        video.pause();
        if (reset) {
          try {
            video.currentTime = 0;
          } catch (e) {
            /* ignore */
          }
        }
      }

      function playVideo(item) {
        const video = getVideo(item);
        if (!video) return;
        const playPromise = video.play();
        if (playPromise && typeof playPromise.then === 'function') {
          playPromise.catch(() => {});
        }
      }

      function closeAll() {
        items.forEach((item) => {
          const btn = item.querySelector('button');
          const panel = item.querySelector('.accordion-content');
          if (!btn || !panel) return;
          btn.setAttribute('aria-expanded', 'false');
          panel.style.gridTemplateRows = '0fr';
          panel.style.paddingTop = '0px';
          panel.style.paddingBottom = '0px';
          panel.hidden = true;
          const inner = panel.firstElementChild;
          if (inner) inner.style.opacity = '0';
          pauseVideo(item, true);
        });
      }

      function openItem(item) {
        const btn = item.querySelector('button');
        const panel = item.querySelector('.accordion-content');
        if (!btn || !panel) return;
        btn.setAttribute('aria-expanded', 'true');
        panel.hidden = false;
        requestAnimationFrame(() => {
          panel.style.gridTemplateRows = '1fr';
          panel.style.paddingTop = '1rem';
          panel.style.paddingBottom = '1rem';
          const inner = panel.firstElementChild;
          if (inner) inner.style.opacity = '1';
        });
        playVideo(item);
      }

      items.forEach((item) => {
        const btn = item.querySelector('button');
        if (!btn) return;
        const panel = item.querySelector('.accordion-content');
        const title = item.querySelector('[data-tab-title]');

        if (btn.getAttribute('aria-expanded') === 'true') {
          if (panel) {
            panel.hidden = false;
            panel.style.gridTemplateRows = '1fr';
            panel.style.paddingTop = '1rem';
            panel.style.paddingBottom = '1rem';
            const inner = panel.firstElementChild;
            if (inner) inner.style.opacity = '1';
          }
          playVideo(item);
        } else {
          pauseVideo(item, true);
        }

        btn.addEventListener('click', () => {
          const isOpen = btn.getAttribute('aria-expanded') === 'true';
          closeAll();
          if (!isOpen) {
            openItem(item);
          }
        });

        applyGradientWord(title);
      });
    });
  </script>
{% endif %}

<style>
  #{{ accordion_id }} .accordion-content {
    transition: grid-template-rows 300ms ease, padding 300ms ease, opacity 250ms ease;
  }
</style>

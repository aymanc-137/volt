{% set accordion_id = 'tap-preview-' ~ (position|default(0)) %}
{% set tabs = component.tabs is iterable ? component.tabs : [] %}
{% set accordion_label = component.accordion_label|default('عناصر العروض') %}
{% set aside_image = component.aside_image|default(null) %}
{% set aside_image_alt = component.aside_image_alt|default(component.aside_title) %}
{% set aside_title = component.aside_title|default('') %}
{% set aside_subtitle = component.aside_subtitle|default('') %}

<section class="s-block tap-preview-component   py-10" dir="rtl">
  <div class="max-w-[85rem] mx-auto px-4 md:px-8">
    <div class="grid lg:grid-cols-3 gap-4   rounded-custom 
    
    dark:bg-[var(--color-dark-box-background)]
    bg-[var(--color-light-box-background)]   overflow-hidden dynamic-border-color">
      <section class="lg:col-span-2 p-4 sm:p-6 space-y-4" id="{{ accordion_id }}" aria-label="{{ accordion_label }}">
        {% if tabs %}
          {% for tab in tabs %}
            {% set tab_panel_id = accordion_id ~ '-panel-' ~ loop.index %}
            {% set is_open = loop.first %}
            <article class="rounded-xl overflow-hidden  bg-cover bg-no-repeat bg-center"
            
            
             {% if tab.image %}
             style="background-image: linear-gradient(to right, rgba(0,0,0,0.5), rgba(255,255,255,.8)),url('{{ tab.image }}');"
                   {% endif %}
             data-accordion-item>
              <button
                type="button"
                class="group relative w-full text-right focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/70"
                aria-expanded="{{ is_open ? 'true' : 'false' }}"
                aria-controls="{{ tab_panel_id }}"
              >
                <div
                  class="h-20 bg-cover bg-center  relative overflow-hidden"
                 
                >
                  {# <div data-accordion-overlay class="absolute w-full h-full  bg-black/40 transition duration-300 ease-in-out"></div> #}
                </div>
                <div class="absolute inset-0 px-4 sm:px-6 flex items-center pointer-events-none">
                  <h3 class="text-white text-xl sm:text-2xl font-extrabold drop-shadow leading-snug">
                    {{ tab.title }}
                  </h3>
                </div>
              </button>

              <div
                id="{{ tab_panel_id }}"
                role="region"
                class="accordion-content grid transition-[grid-template-rows,padding] duration-300 ease-in-out px-4 sm:px-6 bg-gradient-to-b  {{ is_open ? 'grid-rows-[1fr] py-4' : 'grid-rows-[0fr] py-0' }}"
                {% if not is_open %}hidden{% endif %}
              >
                <div class="overflow-hidden transition-opacity w-1/2 duration-300 ease-in-out {{ is_open ? 'opacity-100' : 'opacity-0' }}">
                  <p class="text-neutral-700 leading-7 text-xl">
                    {{ tab.description }}
                  </p>
                </div>
              </div>
            </article>
          {% endfor %}
        {% else %}
          <div class="rounded-xl border border-dashed border-neutral-300 p-6 text-center text-neutral-600">
            أضف عناصر من إعدادات المكون لعرض محتوى المعاينة.
          </div>
        {% endif %}
      </section>

      <aside class="p-6 flex flex-col items-center justify-center rounded-custom">
        {% if aside_image %}
          <img
            src="{{ aside_image }}"
            alt="{{ aside_image_alt }}"
            class="w-full max-w-sm object-contain"
            loading="lazy"
          />
        {% endif %}

        <div class="text-center mt-4 space-y-1">
          {% if aside_title %}
            <h4 class="text-3xl font-black tracking-wide text-neutral-900">{{ aside_title }}</h4>
          {% endif %}
          {% if aside_subtitle %}
            <p class="text-xl font-extrabold text-neutral-800">{{ aside_subtitle }}</p>
          {% endif %}
        </div>
      </aside>
    </div>
  </div>
</section>

{% if tabs %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const container = document.getElementById('{{ accordion_id }}');
      if (!container) return;

      const items = Array.from(container.querySelectorAll('[data-accordion-item]'));
      if (!items.length) return;

      function closeAll() {
        items.forEach((item) => {
          const btn = item.querySelector('button');
          const panel = item.querySelector('.accordion-content');
          const overlay = item.querySelector('[data-accordion-overlay]');
          if (!btn || !panel) return;
          btn.setAttribute('aria-expanded', 'false');
          panel.style.gridTemplateRows = '0fr';
          panel.style.paddingTop = '0px';
          panel.style.paddingBottom = '0px';
          panel.hidden = true;
          const inner = panel.firstElementChild;
          if (inner) inner.style.opacity = '0';
          if (overlay) overlay.style.backgroundColor = 'rgba(0,0,0,0.4)';
        });
      }

      function openItem(item) {
        const btn = item.querySelector('button');
        const panel = item.querySelector('.accordion-content');
        if (!btn || !panel) return;
        btn.setAttribute('aria-expanded', 'true');
        panel.hidden = false;
        requestAnimationFrame(() => {
          panel.style.gridTemplateRows = '1fr';
          panel.style.paddingTop = '1rem';
          panel.style.paddingBottom = '1rem';
          const inner = panel.firstElementChild;
          if (inner) inner.style.opacity = '1';
        });
      }

      items.forEach((item) => {
        const btn = item.querySelector('button');
        if (!btn) return;
        const overlay = item.querySelector('[data-accordion-overlay]');
        const panel = item.querySelector('.accordion-content');

        function syncOverlay(expanded) {
          if (!overlay) return;
          overlay.style.backgroundColor = expanded ? 'rgba(0,0,0,0.2)' : 'rgba(0,0,0,0.4)';
        }

        if (btn.getAttribute('aria-expanded') === 'true') {
          syncOverlay(true);
          if (panel) {
            panel.hidden = false;
            panel.style.gridTemplateRows = '1fr';
            panel.style.paddingTop = '1rem';
            panel.style.paddingBottom = '1rem';
            const inner = panel.firstElementChild;
            if (inner) inner.style.opacity = '1';
          }
        } else {
          syncOverlay(false);
        }

        btn.addEventListener('click', () => {
          const isOpen = btn.getAttribute('aria-expanded') === 'true';
          closeAll();
          if (!isOpen) {
            openItem(item);
            syncOverlay(true);
          }
        });
      });
    });
  </script>
{% endif %}

<style>
  #{{ accordion_id }} .accordion-content {
    transition: grid-template-rows 300ms ease, padding 300ms ease, opacity 250ms ease;
  }
  #{{ accordion_id }} [data-accordion-item] button[aria-expanded="true"] [data-accordion-overlay] {
    background-color: rgba(0, 0, 0, 0.2);
  }
</style>
